<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TechSync - Relat√≥rios Mensais</title>
  <link rel="icon" href="imagem/logo.png">
  <style>
    :root {
        --cor-principal: #6a61ff; 
        --cor-fundo-card: #20202a;
        --cor-fundo-sidebar: #272734;
        --cor-texto-primario: #e1e1e6;
        --cor-texto-secundario: #dbdbe8;
        --cor-destaque: #ff79c6;
        --cor-borda: #383842;
        --sombra: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: #121214 url("imagem/fundo_roxo.png") no-repeat center center/cover; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--cor-texto-primario); height: 100vh;
      display: flex; flex-direction: column; overflow: hidden; 
    }
    
    /* --- Layout Principal --- */
    .dashboard { display: flex; height: 100vh; width: 100%; }

    .sidebar {
        width: 220px; background: var(--cor-fundo-sidebar); padding: 20px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.2); border-right: 1px solid var(--cor-borda);
        transition: width 0.3s ease; overflow: hidden; white-space: nowrap;
        display: flex; flex-direction: column;
    }
    .dashboard.sidebar-toggled .sidebar { width: 0; padding: 0; border: none; }
    
    .sidebar h2 { 
      font-size: 40px; text-align: center; margin-bottom: 20px; color: var(--cor-principal);
      text-shadow: 0 0 10px rgba(106, 97, 255, 0.3);
    }
    .sidebar img { width: 100px; display: block; margin: 0 auto 10px; }
    .sidebar ul { list-style: none; flex: 1; }
    .sidebar li { margin: 15px 0; font-size: 20px; }
    .sidebar a { color: var(--cor-texto-secundario); text-decoration: none; font-weight: 500; transition: color 0.3s; }
    .sidebar a:hover, .sidebar a.active { color: var(--cor-destaque); text-shadow: 0 0 7px var(--cor-destaque);}
    .sidebar a.active { font-weight: 700; }

    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    
    /* --- Header & Filtros --- */
    .header {
      background-color: rgba(39, 39, 52, 0.95); padding: 15px 30px;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--cor-borda); flex-shrink: 0;
    }
    .header-group { display: flex; align-items: center; gap: 15px;}
    
    .filters { display: flex; border: 1px solid var(--cor-borda); border-radius: 5px; overflow: hidden; }
    .btn-filter {
        background: var(--cor-fundo-card); color: var(--cor-texto-secundario); padding: 8px 16px;
        border: none; cursor: pointer; border-right: 1px solid var(--cor-borda); font-weight: 500;
        transition: 0.2s;
    }
    .btn-filter:last-child { border-right: none; }
    .btn-filter:hover { background: #383842; color: #fff; }
    .btn-filter.active { background: var(--cor-principal); color: #fff; }

    .btn-pdf {
        background: var(--cor-principal); color: #fff; padding: 10px 20px; border-radius: 5px;
        border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px;
        transition: 0.3s;
    }
    .btn-pdf:hover { background: var(--cor-destaque); transform: translateY(-2px); }

    .btn-toggle { background: none; border: none; color: #e1e1e6; font-size: 24px; cursor: pointer; }

    /* --- Conte√∫do --- */
    .content { padding: 30px; flex: 1; overflow-y: auto; overflow-x: hidden; }

    .section-title {
        font-size: 1.1rem; color: var(--cor-texto-secundario); margin: 30px 0 15px 0;
        padding-bottom: 5px; border-bottom: 1px solid var(--cor-borda); text-transform: uppercase; letter-spacing: 1px;
    }
    .section-title:first-child { margin-top: 0; }

    /* === NOVOS GRIDS PERSONALIZADOS === */
    
    /* 1. Qualidade e Invent√°rio (3 colunas, cards menores) */
    .metrics-grid { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); /* 3 Colunas: Hosts | SLA | SLA */
        gap: 15px; 
    }
    
    /* 2. Sa√∫de do Sistema (3 colunas: CPU, RAM, Uptime) */
    .system-grid {
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 20px;
    }

    /* 3. Rede (2 colunas: Rede, Lat√™ncia) */
    .network-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); 
        gap: 20px;
    }

    /* 4. Hist√≥rico (Tabela cheia) */
    .history-grid { display: flex; flex-direction: column; gap: 20px; }

    /* Cards */
    .card {
        background: var(--cor-fundo-card); border-radius: 8px; border: 1px solid var(--cor-borda);
        box-shadow: var(--sombra); overflow: hidden; display: flex; flex-direction: column;
        break-inside: avoid; 
    }
    
    /* Alturas personalizadas */
    .metric-card { height: 300px; } 
    .chart-card { height: 400px; }  
    .table-card { height: auto; min-height: 500px; }

    .card-header {
        padding: 8px 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--cor-borda);
        color: var(--cor-destaque); font-weight: 600; font-size: 0.9rem;
    }

    iframe { width: 100%; flex: 1; border: none; pointer-events: none; }
    .interactive iframe { pointer-events: auto; }

    /* Responsividade */
    @media (max-width: 1200px) { 
        .metrics-grid, .system-grid, .network-grid { grid-template-columns: 1fr 1fr; } 
    }
    @media (max-width: 768px) { 
        .metrics-grid, .system-grid, .network-grid { grid-template-columns: 1fr; } 
    }

    /* Impress√£o */
    @media print {
        .sidebar, .btn-toggle, .filters, .btn-pdf { display: none !important; }
        body, .dashboard, .main, .content { background: #fff !important; color: #000 !important; height: auto !important; overflow: visible !important; }
        .card { border: 1px solid #ccc !important; box-shadow: none !important; margin-bottom: 20px; page-break-inside: avoid; }
        .card-header { color: #000 !important; border-bottom: 1px solid #ccc !important; }
    }
  </style>
</head>
<body>
  <div class="dashboard" id="dashboard">
    <aside class="sidebar">
      <div style="text-align: center;">
        <a href="#"><img src="imagem/logo.png" alt="TechSync"></a>
        <h2>TechSync</h2>
      </div>
      <ul>
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="Dispositivos.html">Dispositivos</a></li>
        <li><a href="relatorio.html" class="active">Relat√≥rios</a></li>
        <li><a href="configuracao.html">Configura√ß√µes</a></li>
      </ul>
      <div style="margin-top: auto; text-align: center;">
          <a href="#" id="logoutLink" style="color: #ff5555; text-decoration: none;">Sair da conta</a>
      </div>
    </aside>

    <main class="main">
      <header class="header">
        <div class="header-group">
          <button class="btn-toggle" id="toggleBtn">‚ò∞</button>
          <div>
              <h3 style="margin: 0; font-size: 1.4rem;">Relat√≥rio de Performance</h3>
              <small style="color: var(--cor-texto-secundario);">Gerencie o per√≠odo para an√°lise</small>
          </div>
        </div>

        <div class="header-group">
            <div class="filters">
                <button class="btn-filter" data-range="now-24h">24h</button>
                <button class="btn-filter" data-range="now-7d">7 Dias</button>
                <button class="btn-filter active" data-range="now-30d">30 Dias</button>
            </div>
            <button class="btn-pdf" id="btnPDF">üñ®Ô∏è Imprimir / PDF</button>
            <div style="font-weight: 600;">üë§ <span id="userName">...</span></div>
        </div>
      </header>

      <div class="content" id="reportContent">
        <p style="color: #ccc;">Carregando dados...</p>
      </div>
    </main>
  </div>
  
  <script>
    // --- Configura√ß√£o AVAN√áADA de Layout ---
    const CONFIG = {
        // 1. Qualidade e Invent√°rio (Adicionei 'sla' aqui)
        metrics: ['sla', 'online', 'hosts', 'dispositivos', 'contador', 'count', 'total', 'quantidade'],
        
        // 2. Sa√∫de do Sistema
        system: ['cpu', 'ram', 'mem√≥ria', 'memory', 'uptime', 'disco', 'disk'],
        
        // 3. Rede
        network: ['rede', 'network', 'download', 'upload', 'traffic', 'lat√™ncia', 'ping'],
        
        // 4. Hist√≥rico
        history: ['hist√≥rico', 'history', 'problemas', 'problems', 'eventos', 'logs']
    };

    const username = localStorage.getItem('usuarioLogadoNome');
    const userId = localStorage.getItem('userId');

    document.addEventListener('DOMContentLoaded', () => {
        if (!userId || userId === "undefined") { 
            window.location.href = 'login.html'; 
            return; 
        }
        if (username) {
            document.getElementById('userName').textContent = username.charAt(0).toUpperCase() + username.slice(1);
        }
        
        document.getElementById('btnPDF').onclick = () => window.print();
        document.getElementById('toggleBtn').onclick = () => document.getElementById('dashboard').classList.toggle('sidebar-toggled');
        document.getElementById('logoutLink').onclick = (e) => {
            e.preventDefault(); localStorage.clear(); window.location.href = 'login.html';
        };

        carregarRelatorios();
    });

    async function carregarRelatorios() {
        const contentDiv = document.getElementById('reportContent');
        const API_URL = `http://localhost:3000/users/${userId}/links`;

        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error("Erro de conex√£o");
            const links = await response.json();

            if (!Array.isArray(links) || links.length === 0) {
                contentDiv.innerHTML = '<p style="padding: 20px;">Nenhum relat√≥rio configurado.</p>';
                return;
            }

            contentDiv.innerHTML = '';

            // --- Cria√ß√£o das 4 Se√ß√µes ---
            const sections = {
                metrics: createSection('Qualidade & Invent√°rio', 'metrics-grid'),
                system:  createSection('Sa√∫de do Servidor', 'system-grid'),
                network: createSection('Tr√°fego de Rede', 'network-grid'),
                history: createSection('Hist√≥rico de Eventos', 'history-grid')
            };

            const containers = {
                metrics: sections.metrics.querySelector('.metrics-grid'),
                system:  sections.system.querySelector('.system-grid'),
                network: sections.network.querySelector('.network-grid'),
                history: sections.history.querySelector('.history-grid')
            };

            Object.values(sections).forEach(section => contentDiv.appendChild(section));

            let has = { metrics: false, system: false, network: false, history: false };

            links.forEach(link => {
                const nome = link.name.toLowerCase();
                
                let urlFinal = link.url;
                if (!urlFinal.includes('kiosk')) urlFinal += urlFinal.includes('?') ? '&kiosk' : '?kiosk';
                urlFinal = urlFinal.replace(/&from=.*?&to=.*?&/, '&');

                const cardHTML = `
                    <div class="card-header">${link.name}</div>
                    <iframe src="${urlFinal}" loading="lazy"></iframe>
                `;
                const card = document.createElement('div');
                card.innerHTML = cardHTML;

                // --- L√≥gica de Distribui√ß√£o ---
                if (CONFIG.metrics.some(key => nome.includes(key))) {
                    card.className = 'card metric-card';
                    containers.metrics.appendChild(card);
                    has.metrics = true;
                } 
                else if (CONFIG.system.some(key => nome.includes(key))) {
                    card.className = 'card chart-card';
                    containers.system.appendChild(card);
                    has.system = true;
                }
                else if (CONFIG.network.some(key => nome.includes(key))) {
                    card.className = 'card chart-card';
                    containers.network.appendChild(card);
                    has.network = true;
                }
                else if (CONFIG.history.some(key => nome.includes(key))) {
                    card.className = 'card table-card interactive';
                    containers.history.appendChild(card);
                    has.history = true;
                }
                else {
                    card.className = 'card chart-card';
                    containers.system.appendChild(card);
                    has.system = true;
                }
            });

            if (!has.metrics) sections.metrics.style.display = 'none';
            if (!has.system)  sections.system.style.display = 'none';
            if (!has.network) sections.network.style.display = 'none';
            if (!has.history) sections.history.style.display = 'none';

            initTimeFilters();

        } catch (error) {
            console.error(error);
            contentDiv.innerHTML = `<p style="color: #ff5555;">Erro: ${error.message}</p>`;
        }
    }

    function createSection(title, gridClass) {
        const div = document.createElement('div');
        div.innerHTML = `<h4 class="section-title">${title}</h4><div class="${gridClass}"></div>`;
        return div;
    }

    function initTimeFilters() {
        const btns = document.querySelectorAll('.btn-filter');
        btns.forEach(btn => {
            btn.onclick = () => {
                btns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const range = btn.dataset.range;
                document.querySelectorAll('iframe').forEach(iframe => {
                    try {
                        const url = new URL(iframe.src);
                        url.searchParams.set('from', range);
                        url.searchParams.set('to', 'now');
                        iframe.src = url.toString();
                    } catch (e) {}
                });
            };
        });
    }
  </script>
</body>
</html>